---
apiVersion: v1
kind: Service
metadata:
  name: external-service-status
  namespace: networking
spec:
  type: ExternalName
  externalName: stats.uptimerobot.com
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: external-service-status-ingress
  namespace: networking
  annotations:
    nginx.ingress.kubernetes.io/server-snippets: |
        location / {
            #proxy requests ƒë·∫øn Uptimerobot
            proxy_pass https://stats.uptimerobot.com/k8480TY6yL/;
            #G·ª≠i server_name khi handshake SSL, n·∫øu off th√¨ s·∫Ω b·ªã l·ªói SSL
            proxy_ssl_server_name on;
            #Set header n√†y th√¨ response tr·∫£ v·ªÅ t·ª´ Uptimerobot kh√¥ng b·ªã n√©n, t·ª´ ƒë√≥ m√¨nh c√≥ th·ªÉ replace ·ªü b∆∞·ªõc d∆∞·ªõi
            proxy_set_header Accept-Encoding "";
            #Uptimerobot d√πng header n√†y v·ªõi gi√° tr·ªã 'upgrade-insecure-requests' ƒë·ªÉ tr√¨nh duy·ªát lu√¥n load c√°c css/js v·ªõi HTTPS. ·∫®n header n√†y ƒë·ªÉ c√≥ th·ªÉ truy c·∫≠p v√†o status.nddcoder.com m√† kh√¥ng c·∫ßn HTTPS
            proxy_hide_header Content-Security-Policy;
            #Replace 1 s·ªë link trong response ƒë·ªÉ website load t√†i nguy√™n, c√°c n√∫t tr√™n giao di·ªán ho·∫°t ƒë·ªông ch√≠nh x√°c
            sub_filter https://stats.uptimerobot.com/k8480TY6yL /;
            sub_filter https://stats.uptimerobot.com/ /;
            #X√≥a GTM ƒë·ªÉ Uptimerobot kh√¥ng tracking ƒë∆∞·ª£c m√¨nh üòÄ
            # sub_filter '<script async src="https://www.googletagmanager.com/gtag/js?id=UA-1748433-46"></script>' '';
            # sub_filter </head>
            #         '</head><style>#main-footer{display:none;}</style>';
            #Replace all
            sub_filter_once off;
        }

        #Proxy assets requests
        location /assets {
            proxy_pass https://stats.uptimerobot.com/assets;
            proxy_ssl_server_name on;
        }

        #Proxy api requests
        location /api {
            proxy_pass https://stats.uptimerobot.com/api;
            proxy_ssl_server_name on;
        }
spec:
  rules:
  - host: "status.${SECRET_DOMAIN}"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: external-service-status
            port:
              number: 443
  tls:
  - hosts:
    - "status.${SECRET_DOMAIN}"
